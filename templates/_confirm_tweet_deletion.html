<section id="delete_post_modal"
    style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;"
    onclick="closeDeleteModalOnBackdrop(event)">
    <div style="background: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; margin: 1rem;"
        onclick="event.stopPropagation()">

        <!-- header -->
        <div
            style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
            <header>
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #111827; margin: 0;">Delete post?
                </h3>
            </header>
            <button type="button" onclick="closeDeleteModal()"
                style="color: #9ca3af; background: transparent; border: none; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; cursor: pointer; transition: all 0.2s;">
                &times;
            </button>
        </div>

        <!-- Body -->
        <div style="flex: 1; overflow-y: auto; padding: 1rem 1.5rem;">
            <div class="p-6">
                <p style="color: #6b7280; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.5rem;">
                    This can't be undone and it will be removed from your profile, the timeline of any
                    accounts that
                    follow you, and from search results.
                </p>

                <!-- footer -->
                <div class="flex gap-3 justify-end pt-4 border-t border-gray-200 mt-6">
                    <button type="button" onclick="closeDeleteModal()" class="px-5 py-2.5 cancel-btn">
                        {{ x.lans("cancel") }}
                    </button>
                    <button type="button" onclick="confirmDelete()"
                        style="background-color: #dc2626; color: white; font-weight: 600; padding: 0.625rem 1.25rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.backgroundColor='#b91c1c'"
                        onmouseout="this.style.backgroundColor='#dc2626'">
                        {{ x.lans("delete") }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Global variable to track pending deletion
    let pendingDeletePostPk = null;

    function deletePost(postPk) {
        pendingDeletePostPk = postPk;

        // Show modal
        const modal = document.getElementById('delete_post_modal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        const modal = document.getElementById('delete_post_modal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        pendingDeletePostPk = null;
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' || event.key === 'Esc') {
            const modal = document.getElementById('delete_post_modal');
            if (modal && modal.style.display === 'flex') {
                closeDeleteModal();
            }
        }
    });

    function closeDeleteModalOnBackdrop(event) {
        if (event.target.id === 'delete_post_modal') {
            closeDeleteModal();
        }
    }

    function confirmDelete() {
        if (!pendingDeletePostPk) return;

        fetch(`/api-delete-post/${pendingDeletePostPk}`, {
            method: "DELETE",
            credentials: "include"
        })
            .then(res => {
                if (res.ok) {
                    const postElement = document.getElementById(`post_${pendingDeletePostPk}`);
                    if (postElement) postElement.remove();
                }
                return res.text();
            })
            .then(html => {
                if (typeof mixhtml === 'function') {
                    document.body.insertAdjacentHTML("beforeend", html);
                    mixhtml(html, `/api-delete-post/${pendingDeletePostPk}`);
                }
                closeDeleteModal();
            })
            .catch(err => {
                console.error(err);
                closeDeleteModal();
            });
    }
</script>